(function(){const t={lastEstimate:null,estimating:!1,checkingOut:!1};function e(e){return document.getElementById(e)}function n(){const e=document.body;return{apiBase:e?.dataset?.apiBase||"",stripePk:e?.dataset?.stripePk||"",currencyCode:e?.dataset?.currencyCode||"usd",currencySymbol:e?.dataset?.currency||"$"}}function c(){const{apiBase:e,stripePk:t}=n();if(!e)throw new Error("API base URL is not configured. Set params.api.base in hugo.toml");if(!t)throw new Error("Stripe publishable key is not configured. Set params.stripe.publishable_key in hugo.toml")}function d(e,t){const n=Number(e||0);return`${t||"$"}${n.toFixed(2)}`}function i(){return{name:e("shipName")?.value?.trim()||"",email:e("shipEmail")?.value?.trim()||"",address1:e("shipAddress1")?.value?.trim()||"",address2:e("shipAddress2")?.value?.trim()||"",city:e("shipCity")?.value?.trim()||"",state:e("shipState")?.value?.trim()||"",postal:e("shipPostal")?.value?.trim()||"",country:e("shipCountry")?.value?.trim()||"US"}}function o(e){const t=[];if(e.name||t.push("name"),e.email||t.push("email"),e.address1||t.push("address line 1"),e.city||t.push("city"),e.state||t.push("state"),e.postal||t.push("postal"),e.country||t.push("country"),t.length)throw new Error(`Missing: ${t.join(", ")}`)}function a(){const e=window.Cart&&window.Cart.get&&window.Cart.get()||{items:[]},t=8;return e.items.map(e=>({id:e.id,title:e.title,qty:Number(e.qty||1),price:Number(e.price||0),variantId:e.variantId||null,variantName:e.variantName||null,weight_oz:Number(e.weight_oz||t)}))}async function u(){const{stripePk:e}=n();if(await new Promise(e=>{const t=setInterval(()=>{window.Stripe&&(clearInterval(t),e())},30);setTimeout(()=>{clearInterval(t),e()},1e4)}),!window.Stripe)throw new Error("Stripe.js failed to load");return window.Stripe(e)}function r(n){t.estimating=n;const s=e("estimateShippingBtn");s&&(s.disabled=n);const o=e("shippingEstimate");o&&n&&(o.textContent="Estimating shipping...")}function h(t){const s=e("shippingEstimate");if(!s)return;if(!t||!t.best){s.textContent="Unable to estimate shipping.";return}const{currencySymbol:o}=n();s.innerHTML=`Best rate: <strong>${t.best.carrier} ${t.best.service}</strong> â€” ${d(t.best.amount,o)}${t.best.est_delivery_days?` (ETA ~${t.best.est_delivery_days} days)`:""}`}async function s(){try{c(),r(!0);const{apiBase:u,currencyCode:m}=n(),s=i();o(s);const l=a();if(!l.length)throw new Error("Cart is empty");const e=await fetch(`${u}/estimate-shipping`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({to_address:s,items:l,currency:m})});if(!e.ok)throw new Error(`Estimate failed: ${e.status}`);const d=await e.json();t.lastEstimate=d,h(d)}catch(t){console.error(t);const n=e("shippingEstimate");n&&(n.textContent=t.message||"Estimate failed")}finally{r(!1)}}function l(n){t.checkingOut=n;const o=e("checkoutBtn");o&&(o.disabled=n);const s=document.querySelectorAll(".checkout-btn");s&&s.length&&s.forEach(e=>{e.disabled=n})}async function m(){try{c(),l(!0);const{apiBase:p}=n(),e=i();o(e);const d=a();if(!d.length)throw new Error("Cart is empty");t.lastEstimate||await s();const g=`${location.origin}/checkout/success/?session_id={CHECKOUT_SESSION_ID}`,v=`${location.origin}/checkout/cancel/`,b={email:e.email,shipping_address:e,items:d,shipping_rate:t.lastEstimate?.best||null,success_url:g,cancel_url:v},r=await fetch(`${p}/create-checkout`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)});if(!r.ok)throw new Error(`Checkout failed: ${r.status}`);const h=await r.json(),j=await u(),m=h.id||h.sessionId;if(!m)throw new Error("No session id from server");const{error:f}=await j.redirectToCheckout({sessionId:m});if(f)throw f}catch(e){console.error(e),alert(e.message||"Checkout failed")}finally{l(!1)}}window.Checkout={estimateShipping:s,startCheckout:m},document.addEventListener("DOMContentLoaded",()=>{const t=e("estimateShippingBtn");t&&t.addEventListener("click",s)})})()